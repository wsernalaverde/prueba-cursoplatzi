#!/usr/bin/env node
'use strict';

var _args = require('args');

var _args2 = _interopRequireDefault(_args);

var _microCore = require('micro-core');

var _microCore2 = _interopRequireDefault(_microCore);

var _path = require('path');

var _babelPresetEs = require('babel-preset-es2015');

var _babelPresetEs2 = _interopRequireDefault(_babelPresetEs);

var _babelPluginTransformAsyncToGenerator = require('babel-plugin-transform-async-to-generator');

var _babelPluginTransformAsyncToGenerator2 = _interopRequireDefault(_babelPluginTransformAsyncToGenerator);

var _babelPluginTransformRuntime = require('babel-plugin-transform-runtime');

var _babelPluginTransformRuntime2 = _interopRequireDefault(_babelPluginTransformRuntime);

var _babelPluginModuleAlias = require('babel-plugin-module-alias');

var _babelPluginModuleAlias2 = _interopRequireDefault(_babelPluginModuleAlias);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// babel


_args2.default.option(['p', 'port'], 'Port to listen on', 3000, parseInt).option(['h', 'host'], 'Host to listen on', '0.0.0.0').option(['n', 'no-babel'], 'Skip Babel transformation');

var flags = _args2.default.parse(process.argv);
var file = _args2.default.sub.pop();

if (!file) {
  console.error('\n> \u001b[31mError!\u001b[39m Please supply a file.');
  _args2.default.showHelp();
  process.exit(1);
}

if ('/' !== file[0]) {
  file = (0, _path.resolve)(process.cwd(), file);
}

if (!flags.noBabel) {
  // FIXME: is there a better way to point the `babel-runtime`
  // to the runtime contained in the micro installation?
  var path = require.resolve('babel-runtime/package').replace(/[\\\/]package.json$/, '');

  require('babel-register')({
    presets: [_babelPresetEs2.default],
    plugins: [_babelPluginTransformAsyncToGenerator2.default, _babelPluginTransformRuntime2.default, [_babelPluginModuleAlias2.default, [{ src: path, expose: 'babel-runtime' }]]]
  });
}

var mod = require(file).default;

if ('function' !== typeof mod) {
  console.error('> \u001b[31mError!\u001b[39m "' + file + '" does not export a function.');
  process.exit(1);
}

var port = flags.port || 3000;
var host = flags.host || '0.0.0.0';

(0, _microCore2.default)(mod).listen(port, host, function (err) {
  if (err) {
    console.error(err.stack);
    process.exit(1);
  }

  console.log('> \u001b[96mReady!\u001b[39m Listening on ' + host + ':' + port + '.');
});

// TODO: test listen error
// add success message